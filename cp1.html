<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Tourist Safety Dashboard</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet CSS/JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- QR Code -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    #map { height: 400px; width: 100%; border-radius: 0.5rem; }
    #incidentModal { z-index: 9999 !important; }
    #map, .leaflet-pane, .leaflet-top, .leaflet-bottom { z-index: 0 !important; }
  </style>
</head>

<body class="bg-slate-50 text-slate-800 flex min-h-screen">

  <!-- Sidebar -->
  <aside class="w-64 bg-sky-800 text-white p-6 flex flex-col space-y-6">
    <h2 class="text-2xl font-bold mb-6">Smart Tourist Safety</h2>
    <nav class="space-y-3">
      <button onclick="showSection('overview')" class="w-full text-left hover:bg-sky-700 p-2 rounded">üè† Overview</button>
      <button onclick="showSection('registration')" class="w-full text-left hover:bg-sky-700 p-2 rounded">ü™™ Register</button>
      <button onclick="showSection('location')" class="w-full text-left hover:bg-sky-700 p-2 rounded">üìç Live Location</button>
      <button onclick="showSection('crowd')" class="w-full text-left hover:bg-sky-700 p-2 rounded">üë• Crowd Check</button>
      <button onclick="showSection('incident')" class="w-full text-left hover:bg-sky-700 p-2 rounded">üö® Emergency</button>
      <button onclick="showSection('profile')" class="w-full text-left hover:bg-sky-700 p-2 rounded">üë§ Profile</button>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-6 space-y-6">

    <!-- Overview -->
    <section id="overview" class="section">
      <h1 class="text-2xl font-semibold mb-4">Dashboard Overview</h1>
      <p>Welcome to the Smart Tourist Safety System. Use the sidebar to access registration, live tracking, or report incidents.</p>
    </section>

    <!-- Registration -->
    <section id="registration" class="section hidden">
      <h2 class="text-xl font-semibold mb-3">Tourist Registration</h2>
      <div class="bg-white p-5 rounded shadow space-y-3">
        <input id="name" type="text" placeholder="Name" class="w-full border p-2 rounded">
        <input id="age" type="number" placeholder="Age" class="w-full border p-2 rounded">
        <input id="contact" type="text" placeholder="Contact" class="w-full border p-2 rounded">
        <div class="flex gap-3">
          <button id="registerBtn" class="bg-sky-600 text-white px-4 py-2 rounded">Register</button>
          <button id="clearQR" class="border px-4 py-2 rounded">Clear</button>
        </div>
        <div id="qrcode" class="mt-3"></div>
      </div>
    </section>

    <!-- Live Location -->
    <section id="location" class="section hidden">
      <h2 class="text-xl font-semibold mb-3">Live Location</h2>
      <div class="bg-white p-4 rounded shadow space-y-3">
        <div id="map"></div>
        <div class="flex gap-3">
          <button id="centerBtn" class="bg-sky-600 text-white px-4 py-2 rounded">Center Map</button>
          <button id="toggleFollow" class="border px-4 py-2 rounded">Toggle Follow</button>
        </div>
      </div>
    </section>

    <!-- Crowd -->
    <section id="crowd" class="section hidden">
      <h2 class="text-xl font-semibold mb-3">Crowd Density</h2>
      <div class="bg-white p-5 rounded shadow space-y-3">
        <input id="crowdCount" type="number" placeholder="Number of people" class="w-full border p-2 rounded">
        <button id="crowdBtn" class="bg-orange-500 text-white px-4 py-2 rounded">Check Crowd</button>
        <p class="text-sm text-slate-500">If crowd > 50 ‚Üí system marks high density.</p>
      </div>
    </section>

    <!-- Incident -->
    <section id="incident" class="section hidden">
      <h2 class="text-xl font-semibold mb-3">Incident / SOS</h2>
      <button id="openIncident" class="bg-red-600 text-white px-4 py-2 rounded">Report Incident</button>
    </section>

    <!-- Profile Section -->
    <section id="profile" class="section hidden">
      <div class="bg-white p-6 rounded shadow max-w-md mx-auto space-y-5">

        <!-- Profile Picture and Name -->
        <div class="flex flex-col items-center space-y-2">
          <img id="profilePic" src="https://via.placeholder.com/100"
               class="w-24 h-24 rounded-full border-2 border-sky-600 object-cover"
               alt="Profile Picture">
          <div class="flex items-center space-x-2">
            <h2 id="profileDisplayName" class="text-xl font-semibold">John Doe</h2>
            <span id="verifiedTick" class="hidden text-green-600 text-xl">‚úîÔ∏è</span>
          </div>
          <input id="uploadPic" type="file" accept="image/*" class="text-sm">
        </div>

        <!-- Profile Form -->
        <div class="space-y-3">
          <label>Name</label>
          <input id="profNameInput" type="text" class="w-full border p-2 rounded" placeholder="Enter your name">

          <label>Contact</label>
          <input id="profContactInput" type="text" class="w-full border p-2 rounded" placeholder="Enter your contact">

          <label>Email</label>
          <div class="flex gap-2 items-center">
            <input id="profEmailInput" type="email" class="flex-1 border p-2 rounded" placeholder="Enter your email">
            <button id="sendOtp" class="bg-sky-600 text-white px-3 py-1 rounded">Send OTP</button>
          </div>

          <div id="otpSection" class="hidden flex gap-2 items-center mt-2">
            <input id="otpInput" type="text" placeholder="Enter OTP" class="border p-2 rounded flex-1">
            <button id="verifyOtp" class="bg-green-600 text-white px-3 py-1 rounded">Verify</button>
          </div>

          <label>Country</label>
          <input id="profCountryInput" type="text" class="w-full border p-2 rounded" placeholder="Enter your country">

          <label>Registration Date</label>
          <input id="profRegDate" type="text" class="w-full border p-2 rounded bg-slate-100" readonly>

          <label>Digital ID (Blockchain)</label>
          <div class="flex items-center gap-2">
            <input id="profDigitalID" type="text" class="flex-1 border p-2 rounded bg-slate-100" readonly>
            <span id="blockchainTick" class="text-green-600 text-xl hidden">‚úîÔ∏è</span>
          </div>

          <button id="saveProfile" class="bg-sky-600 text-white px-4 py-2 rounded w-full">Save Profile</button>
          <button id="editProfile" class="bg-yellow-500 text-white px-4 py-2 rounded w-full hidden">Edit Profile</button>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-2 gap-4 text-center mt-4">
          <div class="bg-slate-50 p-3 rounded shadow">
            <p class="text-xl font-bold" id="incidentCount">0</p>
            <p class="text-sm text-slate-500">Incidents Reported</p>
          </div>
          <div class="bg-slate-50 p-3 rounded shadow">
            <p class="text-xl font-bold" id="crowdCheckCount">0</p>
            <p class="text-sm text-slate-500">Crowd Checks Done</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Log -->
    <section class="bg-white p-4 rounded shadow">
      <h3 class="text-lg font-medium mb-2">Activity Log</h3>
      <div id="log" class="text-sm text-slate-600 max-h-40 overflow-auto bg-slate-50 p-2 rounded"></div>
    </section>

  </main>

  <!-- Incident Modal -->
  <div id="incidentModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-40">
    <div class="bg-white rounded-lg p-5 shadow w-full max-w-md">
      <h3 class="text-lg font-semibold mb-3">Report Incident</h3>
      <textarea id="incidentText" rows="4" placeholder="Describe the incident..." class="w-full border p-2 rounded"></textarea>
      <div class="mt-4 flex justify-end gap-2">
        <button id="closeIncident" class="border px-3 py-1 rounded">Cancel</button>
        <button id="submitIncident" class="bg-red-600 text-white px-3 py-1 rounded">Send</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="fixed right-6 bottom-6 space-y-3 z-50"></div>

<script>
window.addEventListener('DOMContentLoaded',()=>{

// Section Navigation
window.showSection = (id)=>{
  document.querySelectorAll('.section').forEach(s=>s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  if(id==='location' && map) setTimeout(()=>map.invalidateSize(),200);
};
showSection('overview');

// Toast
function showToast(type,msg,ttl=4000){
  const colors={info:'bg-sky-600',success:'bg-green-600',warn:'bg-yellow-500 text-slate-900',error:'bg-red-600'};
  const div=document.createElement('div');
  div.className=`max-w-sm p-3 rounded shadow text-white ${colors[type]||colors.info} flex justify-between items-start`;
  div.innerHTML=`<div class="flex-1 text-sm">${msg}</div><button class="ml-2">‚úï</button>`;
  document.getElementById('toastContainer').appendChild(div);
  div.querySelector('button').addEventListener('click',()=>div.remove());
  setTimeout(()=>div.remove(),ttl);
}

// Log
function log(msg){
  const d=new Date().toLocaleTimeString();
  document.getElementById('log').innerHTML=`<div class="py-0.5">[${d}] ${msg}</div>`+document.getElementById('log').innerHTML;
}

// Map
const map=L.map('map').setView([25.0,82.5],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OpenStreetMap contributors'}).addTo(map);
const restrictedZone=L.circle([25.002,82.502],{radius:100,color:'red',fillOpacity:0.06}).addTo(map);
L.marker(restrictedZone.getLatLng(),{interactive:false}).addTo(map)
  .bindTooltip("Restricted Zone",{permanent:true,direction:'top',className:'bg-red-600 text-white rounded px-2 py-0.5'}).openTooltip();

let userMarker=null,followUser=true;

document.getElementById('centerBtn').addEventListener('click',()=>{if(userMarker) map.setView(userMarker.getLatLng(),15);});
document.getElementById('toggleFollow').addEventListener('click',()=>{followUser=!followUser;showToast('info',followUser?'Follow ON':'Follow OFF',2000);log('Follow mode: '+(followUser?'ON':'OFF'));});

// Geolocation
if(navigator.geolocation){
  navigator.geolocation.watchPosition(pos=>{
    const lat=pos.coords.latitude,lng=pos.coords.longitude;
    if(!userMarker) userMarker=L.marker([lat,lng],{title:'You',riseOnHover:true}).addTo(map).bindPopup('You are here');
    else userMarker.setLatLng([lat,lng]);
    if(followUser) map.setView([lat,lng], map.getZoom()<14?15:map.getZoom());
    // Restricted zone
    if(map.distance([lat,lng], restrictedZone.getLatLng()) <= restrictedZone.getRadius()){
      showToast('error','‚ö† You entered a restricted area!');
      log('Entered restricted zone');
    }
  }, err=>{
    showToast('error','Location error: '+err.message,8000);
    log('Geo error: '+err.message);
  }, {enableHighAccuracy:true, maximumAge:0, timeout:10000});
} else showToast('error','Geolocation not supported');

// Registration & QR
document.getElementById('registerBtn').addEventListener('click', async () => {
  const name = document.getElementById('name').value || 'Anonymous';
  const age = document.getElementById('age').value || '-';
  const contact = document.getElementById('contact').value || '-';

  // Generate QR locally
  document.getElementById('qrcode').innerHTML = '';
  new QRCode(document.getElementById('qrcode'), {
    text: JSON.stringify({ name, age, contact }),
    width: 140,
    height: 140
  });

  // Send data to Flask backend
  try {
    const res = await fetch("http://localhost:5000/api/register", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, age, contact })
    });
    const data = await res.json();

    if (res.ok) {
      showToast("success", "Tourist registered & stored in database!");
      log(`Registered tourist: ${name}`);
      // Fill registration date & digital ID from backend
      document.getElementById('profRegDate').value = data.registrationDate;
      // You can also update profile digital ID if needed
    } else {
      showToast("error", data.error || "Registration failed!");
    }
  } catch (err) {
    showToast("error", "Server error: " + err.message);
  }
});

// Crowd check
document.getElementById('crowdBtn').addEventListener('click',()=>{
  const c=parseInt(document.getElementById('crowdCount').value||'0');
  if(isNaN(c)){ showToast('warn','Enter valid number'); return; }
  if(c>50){ showToast('warn','High crowd density!'); log('High crowd: '+c); }
  else{ showToast('success','Crowd safe'); log('Crowd check: '+c); }
});

// Incident modal
document.getElementById('openIncident').addEventListener('click',()=>document.getElementById('incidentModal').classList.remove('hidden'));
document.getElementById('closeIncident').addEventListener('click',()=>document.getElementById('incidentModal').classList.add('hidden'));
document.getElementById('submitIncident').addEventListener('click',()=>{
  const text=document.getElementById('incidentText').value.trim();
  if(!text){ showToast('warn','Enter incident'); return; }
  showToast('info','Incident reported'); 
  log('Incident: '+text);
  document.getElementById('incidentModal').classList.add('hidden');
  document.getElementById('incidentText').value='';
});

// Profile management
let profile = {
  name:"John Doe", contact:"+91 1234567890", email:"john@example.com", country:"India",
  profilePic:"https://via.placeholder.com/100", registrationDate:new Date().toLocaleDateString(),
  digitalID:"BLOCKCHAIN12345", incidents:3, crowdChecks:7, verified:false, blockchainVerified:true
};

function loadProfile(){
  document.getElementById('profNameInput').value=profile.name;
  document.getElementById('profContactInput').value=profile.contact;
  document.getElementById('profEmailInput').value=profile.email;
  document.getElementById('profCountryInput').value=profile.country;
  document.getElementById('profilePic').src=profile.profilePic;
  document.getElementById('profRegDate').value=profile.registrationDate;
  document.getElementById('profDigitalID').value=profile.digitalID;
  document.getElementById('incidentCount').innerText=profile.incidents;
  document.getElementById('crowdCheckCount').innerText=profile.crowdChecks;
  document.getElementById('profileDisplayName').innerText=profile.name;
  document.getElementById('verifiedTick').style.display=profile.verified?'inline':'none';
  document.getElementById('blockchainTick').style.display=profile.blockchainVerified?'inline':'none';
  document.getElementById('saveProfile').style.display=profile.verified?'none':'block';
  document.getElementById('editProfile').style.display=profile.verified?'block':'none';
}
loadProfile();

// Profile picture upload
document.getElementById('uploadPic').addEventListener('change', e=>{
  const file=e.target.files[0];
  if(file){
    const reader=new FileReader();
    reader.onload=ev=>{ profile.profilePic=ev.target.result; document.getElementById('profilePic').src=profile.profilePic; };
    reader.readAsDataURL(file);
  }
});

// OTP simulation
let currentOtp='';
document.getElementById('sendOtp').addEventListener('click',()=>{
  currentOtp=Math.floor(100000+Math.random()*900000).toString();
  showToast('info','OTP sent: '+currentOtp,6000);
  document.getElementById('otpSection').classList.remove('hidden');
});

document.getElementById('verifyOtp').addEventListener('click',()=>{
  const otpInput=document.getElementById('otpInput').value.trim();
  if(otpInput===currentOtp){
    showToast('success','Email verified');
    profile.verified=true;
    loadProfile();
    document.getElementById('otpSection').classList.add('hidden');
  }else showToast('error','Invalid OTP');
});

// Save profile
document.getElementById('saveProfile').addEventListener('click',()=>{
  profile.name=document.getElementById('profNameInput').value;
  profile.contact=document.getElementById('profContactInput').value;
  profile.email=document.getElementById('profEmailInput').value;
  profile.country=document.getElementById('profCountryInput').value;
  loadProfile();
  showToast('success','Profile saved');
});

});
</script>

</body>
</html>
